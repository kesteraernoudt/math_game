<!DOCTYPE html>
<!-- ¬© Cigav Productions LLC -->
<html>
<head>
    <title>{{ game_info.name if game_info else 'Math Game' }}</title>
    <!-- Font Awesome removed (blocked by browser). Using Unicode arrows and emojis instead. -->
    <style>
        :root {
            --bg: #0b1220;
            --panel: #0e213d;
            --text: #f8fafc;
            --muted: #cbd5e1;
        }
        body {
            font-family: Arial, sans-serif;
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px;
            text-align: center;
            background: radial-gradient(circle at 15% 20%, #1f2f4f, var(--bg) 60%);
            color: var(--text);
            font-size: 18px;
        }
        .history {
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background-color: rgba(255,255,255,0.04);
            border-radius: 10px;
        }
        .history-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 8px;
            background-color: var(--panel);
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.18);
        }
        .history-number {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text);
        }
        .history-answer {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
        }
        .history-result {
            font-size: 1.2em;
        }
        .history-result.correct {
            color: #2ecc71;
        }
        .history-result.incorrect {
            color: #e74c3c;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-size: 1.2em;
            background: rgba(255,255,255,0.06);
            color: var(--text);
        }
        .game-box {
            border: 1px solid rgba(255,255,255,0.08);
            padding: 36px;
            border-radius: 18px;
            margin: 24px 0;
            background-color: var(--panel);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.35);
        }
        .number-display {
            font-size: 84px;
            font-weight: bold;
            margin: 34px 0;
            color: var(--text);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        .answer-buttons {
            margin: 34px 0;
            display: flex;
            justify-content: center;
            gap: 44px;
        }
        .btn {
            padding: 22px;
            font-size: 28px;
            cursor: pointer;
            border: none;
            border-radius: 50%;
            width: 92px;
            height: 92px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background-color 0.2s;
        }
        .btn-up {
            background-color: #cc822e;
            color: white;
        }
        .btn-down {
            background-color: #613ce7;
            color: white;
        }
        .btn:hover {
            transform: scale(1.1);
        }
        .btn-up:hover {
            background-color: #cc822e;
        }
        .btn-down:hover {
            background-color: #613ce7;
        }
        .factor-btn {
            opacity: 0.95;
            transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
        }
        .factor-btn.selected {
            box-shadow: 0 8px 18px rgba(0,0,0,0.18);
            transform: translateY(-3px);
            opacity: 1;
        }
        .score {
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
            color: #34495e;
        }
        .feedback {
            font-size: 54px;
            margin: 24px 0;
            animation: fadeIn 0.5s;
        }
        .feedback.correct {
            color: #2ecc71;
        }
        .feedback.incorrect {
            color: #e74c3c;
        }
        .round-info {
            font-size: 1.2em;
            color: #7f8c8d;
            margin: 10px 0;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        .start-btn {
            padding: 18px 36px;
            font-size: 22px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .start-btn:hover {
            background-color: #2980b9;
        }
        .active-wrap {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
            justify-content: center;
        }
        .axis-row {
            display: flex;
            align-items: stretch;
            justify-content: center;
            gap: 24px;
            width: 100%;
        }
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: stretch;
            min-width: 260px;
            flex: 1 1 100%;
        }
        .latest-msg {
            padding: 12px;
            border-radius: 12px;
            background: rgba(255,255,255,0.08);
            font-weight: 700;
        }
        .message-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        @media (orientation: landscape) {
            body { max-width: 1200px; padding: 18px; }
            .game-box { padding: 32px; }
            .active-wrap { flex-direction: row; align-items: flex-start; gap: 26px; }
            .axis-row { justify-content: flex-start; gap: 30px; }
            .side-panel { max-width: 520px; }
            .nav-link { margin-bottom: 10px; }
        }
        /* CSS for the highly visible selected button */
        .factor-btn.selected {
            /* Add a transition for a smooth visual effect */
            transition: all 0.2s ease-in-out; 
            
            /* 1. High-Contrast Border & Box Shadow */
            /* Adds a glowing effect around the selected button (bright yellow/gold) */
            box-shadow: 0 0 15px 5px rgba(255, 0, 0, 0.8) !important;
            
            /* Optional: Thicker border for more emphasis */
            border-width: 4px !important; 
            border-color: #ff0000 !important; /* Bright yellow border */
            
            /* 2. Scale Transformation */
            /* Makes the button slightly larger to stand out */
            transform: scale(1.28); 
            
            /* 3. Text Change (Optional but helps) */
            /* Ensures the text is visible against the glow if needed */
            font-weight: bold !important; 
        }
        .nav-link {
            display: inline-block;
            margin-bottom: 12px;
            padding: 10px 20px;
            background-color: #95a5a6;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .nav-link:hover {
            background-color: #7f8c8d;
        }
    </style>
</head>
<body>
    <!-- Main content -->
    <!-- TEMPLATE MARKER and SIMPLE TEST BLOCK (hidden by default unless show_debug=true) -->
    <div id="template-marker" style="{% if not show_debug %}display:none;{% endif %}background:#d4edda;color:#155724;padding:6px;border-radius:6px;margin-bottom:10px;">TEMPLATE MARKER: game.html v4</div>

    <div id="simple-test-block" style="{% if not show_debug %}display:none;{% endif %}background:#e6f7ff;color:#0c5460;padding:8px;border-radius:6px;margin-bottom:10px;"> 
        TEST BLOCK: session.current_number='{{ session.get('current_number') }}' | messages_len='{{ messages|length }}' | history_len='{{ session.get('history')|length }}' |first_msg='{{ messages[0] if messages|length>0 else '' }}' | game_active='{{ game_active }}' | game_over='{{ game_over }}'
    </div>

    <!-- ALWAYS-VISIBLE FLEX ROW: shows session current_number centrally (debugging aid) -->
    {% if False and game_active and not game_over %}
    <div id="always-show-row" style="display:flex;align-items:center;justify-content:center;gap:40px;margin:12px 0;position:relative;z-index:9999;">
        <div role="button" tabindex="0" onclick="postAnswer('up')" onkeydown="if(event.key==='Enter'||event.key===' ')postAnswer('up')" style="width:90px;height:90px;border-radius:50%;background:#cc822e;display:flex;align-items:center;justify-content:center;color:white;font-size:36px;pointer-events:auto;cursor:pointer;position:relative;z-index:9999;">‚ñ≤</div>
        <div style="font-size:84px;font-weight:bold;color:#2c3e50;">{{ session.get('current_number') }}</div>
        <div role="button" tabindex="0" onclick="postAnswer('down')" onkeydown="if(event.key==='Enter'||event.key===' ')postAnswer('down')" style="width:90px;height:90px;border-radius:50%;background:#613ce7;display:flex;align-items:center;justify-content:center;color:white;font-size:36px;pointer-events:auto;cursor:pointer;position:relative;z-index:9999;">‚ñº</div>
    </div>
    {% endif %}

    <div class="game-box">
        {% if game_active %}
            {% set show_axis = game_config.get('show_axis', default_config.get('show_axis', True)) %}
            <div class="active-wrap">
                <div class="axis-row">
                {% if show_axis %}
                    {% set max_num = game_config.get('max_number', default_config.get('max_number', 100)) %}
                    {% set factor = game_config.get('factor', default_config.get('factor', 10)) %}
                    {% set current_num = session.get('current_number') %}
                    <div style="position:relative; width:150px; height:500px;">
                        <div style="position:absolute; left:32px; top:0; bottom:0; width:110px; border-left:3px solid #94a3b8; background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0)); border-radius:8px;">
                            {% set last_tick = (max_num // factor) * factor %}
                            {% for val in range(0, max_num + factor, factor) %}
                                {% if val <= max_num %}
                                    {% set pct = (val / max_num * 100) if max_num > 0 else 0 %}
                                    <div style="position:absolute; left:0; width:100%; bottom:{{ pct }}%; display:flex; align-items:center; gap:8px; transform: translateY(50%);">
                                        <div style="height:3px; width:18px; background:#94a3b8;"></div>
                                        <div style="font-size:20px; color:#475569; font-weight:800;">{{ val }}</div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                            {% if last_tick != max_num %}
                                {% set pct = (max_num / max_num * 100) if max_num > 0 else 0 %}
                                <div style="position:absolute; left:0; width:100%; bottom:{{ pct }}%; display:flex; align-items:center; gap:8px; transform: translateY(50%);">
                                    <div style="height:3px; width:18px; background:#94a3b8;"></div>
                                    <div style="font-size:20px; color:#475569; font-weight:800;">{{ max_num }}</div>
                                </div>
                            {% endif %}
                            <div style="position:absolute; left:-8px; bottom:-6px; width:16px; height:16px; background:#94a3b8; border-radius:50%;"></div>
                            <div style="position:absolute; left:-8px; top:-8px; width:16px; height:16px; background:#94a3b8; border-radius:50%; opacity:0.6;"></div>
                        </div>
                            {% set current_num = session.get('current_number') %}
                            {% if current_num is not none %}
                                {% set num_pct = (current_num / max_num * 100) if max_num > 0 else 0 %}
                                <div style="position:absolute; left:-30px; bottom:{{ num_pct }}%; transform: translateY(50%); width:70px; height:44px; background:url(&quot;data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 80'><path d='M0 40 L80 40 L80 10 L120 40 L80 70 L80 40 L0 40 Z' fill='%23e11d48' stroke='%23ffffff' stroke-width='4'/></svg>&quot;) center/contain no-repeat; filter: drop-shadow(0 0 8px rgba(225,29,72,0.6));"></div>
                            {% endif %}
                        </div>
                    <div style="display:flex; flex-direction:column; align-items:center; gap:18px;">
                        <button id="interactive-up" data-answer="up" class="btn btn-up" style="height: 110px; width: 110px; font-size: 56px;">&#9650;</button>
                        <div class="number-display" style="font-size: 150px; min-width: 180px; margin:0 0 0 10px; line-height:1; color:#f8fafc;">{{ session.get('current_number') }}</div>
                        <button id="interactive-down" data-answer="down" class="btn btn-down" style="height: 110px; width: 110px; font-size: 56px;">&#9660;</button>
                    </div>
                {% else %}
                    <div id="interactive-row" style="display: flex; align-items: center; justify-content: center; gap: 60px; margin: 20px 0 10px 0;">
                        <button id="interactive-up" data-answer="up" class="btn btn-up" style="height: 120px; width: 120px; font-size: 60px;">
                            &#9650;
                        </button>
                        <div class="number-display" style="font-size: 140px; min-width: 240px; margin: 0 20px;">{{ session.get('current_number') }}</div>
                        <button id="interactive-down" data-answer="down" class="btn btn-down" style="height: 120px; width: 120px; font-size: 60px;">
                            &#9660;
                        </button>
                    </div>
                {% endif %}
                </div>
                <div class="side-panel">
                    {% if messages|length > 0 %}
                        <div class="latest-msg">{{ messages[-1] }}</div>
                    {% endif %}
                    {% if messages|length > 1 %}
                    <div class="message-list">
                        {% for message in messages[:-1] %}
                            <div class="message">{{ message }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

        {% else %}
            {% set prev_config = game_config %}
            {% set default_config = default_config %}

            <!-- DEBUG BLOCK: hidden by default unless show_debug is true -->
            <div style="{% if not show_debug %}display:none;{% endif %}background:#fff3cd; color:#856404; padding:8px; border-radius:6px; margin:12px 0;">
                DEBUG: current_number='{{ session.get('current_number') }}' | game_config='{{ prev_config }}' | default_config='{{ default_config }}'
            </div>

            <form method="POST" style="margin-top: 30px;">
                <div style="margin-bottom: 18px; font-size:18px; display:flex; flex-direction:column; gap:14px; align-items:center;">
                    {% if 'factor' in default_config %}
                    <div style="width:100%; text-align:center;">
                        <div style="font-weight:600; margin-bottom:8px;">Factor</div>
                        <div class="touch-toggle" style="display:inline-flex; gap:12px;">
                            <input type="hidden" id="factor" name="factor" value="{{ prev_config.get('factor', default_config.get('factor', 10)) }}">
                            
                            <button type="button" data-value="5" class="factor-btn {% if prev_config.get('factor', default_config.get('factor', 10)) == 5 %}selected{% endif %}" style="padding:12px 20px; font-size:20px; border-radius:10px; border:2px solid #cc822e; background:#cc822e; color:#fff; min-width:90px;">5</button>
                            
                            <button type="button" data-value="10" class="factor-btn {% if prev_config.get('factor', default_config.get('factor', 10)) == 10 %}selected{% endif %}" style="padding:12px 20px; font-size:20px; border-radius:10px; border:2px solid #613ce7; background:#613ce7; color:#fff; min-width:90px;">10</button>
                        </div>
                    </div>
                    {% endif %}

                    <div style="display:flex; gap:18px; align-items:center; flex-wrap: wrap; justify-content: center;">
                        {% if 'rounds' in default_config %}
                        <div style="text-align:center;">
                            <div style="font-weight:700; margin-bottom:10px; font-size:22px;">Rounds</div>
                            <div class="touch-stepper" style="display:flex; gap:10px; align-items:center;">
                                <button type="button" class="step-minus" style="font-size:28px; padding:12px 14px; border-radius:10px;">‚àí</button>
                                <input type="number" id="rounds" name="rounds" min="1" value="{{ prev_config.get('rounds', default_config.get('rounds', 10)) }}" style="width:110px; font-size:24px; padding:12px; text-align:center; border-radius:10px;">
                                <button type="button" class="step-plus" style="font-size:28px; padding:12px 14px; border-radius:10px;">+</button>
                            </div>
                        </div>
                        {% endif %}

                        {% if 'max_number' in default_config %}
                        <div style="text-align:center;">
                            <div style="font-weight:700; margin-bottom:10px; font-size:22px;">Max Number</div>
                            <div class="touch-stepper" style="display:flex; gap:10px; align-items:center;">
                                <button type="button" class="max-minus" style="font-size:28px; padding:12px 14px; border-radius:10px;">‚àí</button>
                                <input type="number" id="max_number" name="max_number" min="1" value="{{ prev_config.get('max_number', default_config.get('max_number', 100)) }}" style="width:120px; font-size:24px; padding:12px; text-align:center; border-radius:10px;">
                                <button type="button" class="max-plus" style="font-size:28px; padding:12px 14px; border-radius:10px;">+</button>
                            </div>
                        </div>
                        {% endif %}
                        {% if 'show_axis' in default_config %}
                        <div style="text-align:center;">
                            <label style="font-weight:700; margin-bottom:10px; font-size:22px; display:block;" for="show_axis">Show Axis</label>
                            {% set axis_val = prev_config.get('show_axis', default_config.get('show_axis', True)) %}
                            <label style="display:flex; align-items:center; justify-content:center; gap:12px; font-size:22px; cursor:pointer;">
                                <input type="checkbox" id="show_axis" name="show_axis" value="true" {% if axis_val %}checked{% endif %} style="width:26px; height:26px; accent-color:#38bdf8;">
                                <span>Enabled</span>
                            </label>
                            <input type="hidden" name="show_axis_present" value="1">
                        </div>
                        {% endif %}
                    </div>
                </div>
                <button type="submit" name="action" value="start_game" class="start-btn" style="font-size:22px; padding:18px 36px;">Start Game</button>
            </form>
            </div>
        {% endif %}
        {% if session.games and session.games.get(game_id) and session.games[game_id].get('current_round', 0) > 0 %}
            <div class="score-item">
                <div class="number-display" style="font-size: 60px; min-width: 220px; margin: 0 20px;">Score: {{ session.games[game_id].get('score', 0) }} / {{ session.games[game_id].get('current_round', 0) }}</div>
            </div>
        {% endif %}
        {% for entry in session.history|reverse %}
            <div class="history-item">
                <span class="history-number">{{ entry.number }}</span>
                <span class="history-answer">
                    {% if entry.answer == 'up' %}
                        &#9650; Up
                    {% else %}
                        &#9660; Down
                    {% endif %}
                </span>
                <span class="history-result {{ 'correct' if entry.is_correct else 'incorrect' }}">
                    {% if entry.is_correct %}
                        üëç
                    {% else %}
                        üëé
                    {% endif %}
                </span>
            </div>
        {% endfor %}
        {% if game_active %}
            <div class="restart_game">
                <form method="POST" style="margin-top: 30px;">
                    <button type="submit" name="action" value="restart" class="start-btn" style="font-size:20px; padding:14px 28px;">Restart Game</button>
                </form>
            </div>
        {% endif %}
    </div>
    
    <script>
        // JS handler to submit answer via POST when interactive buttons are clicked
        function postAnswer(ans) {
            const f = document.createElement('form');
            f.method = 'POST';
            f.style.display = 'none';
            const input = document.createElement('input');
            input.name = 'answer';
            input.value = ans;
            f.appendChild(input);
            document.body.appendChild(f);
            f.submit();
        }
        document.addEventListener('DOMContentLoaded', function(){
            const up = document.getElementById('interactive-up');
            const down = document.getElementById('interactive-down');
            if (up) up.addEventListener('click', function(){ postAnswer('up'); });
            if (down) down.addEventListener('click', function(){ postAnswer('down'); });
        });
        // Touch-friendly controls: factor buttons and steppers
        document.addEventListener('DOMContentLoaded', function(){
            // Factor buttons
            const factorHidden = document.getElementById('factor');
            const factorBtns = document.querySelectorAll('.factor-btn');
            // initialize selection from hidden input value
            factorBtns.forEach(btn => {
                const val = btn.getAttribute('data-value');
                if (factorHidden && factorHidden.value === val) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
                btn.addEventListener('click', function(){
                    factorBtns.forEach(b=>b.classList.remove('selected'));
                    this.classList.add('selected');
                    if (factorHidden) factorHidden.value = this.getAttribute('data-value');
                });
            });

            // Rounds stepper
            const roundsInput = document.getElementById('rounds');
            const minus = document.querySelector('.step-minus');
            const plus = document.querySelector('.step-plus');
            if (minus) minus.addEventListener('click', ()=>{ if(roundsInput && Number(roundsInput.value) > 1) roundsInput.value = Number(roundsInput.value)-1; });
            if (plus) plus.addEventListener('click', ()=>{ if(roundsInput) roundsInput.value = Number(roundsInput.value)+1; });

            // Max number stepper
            const maxInput = document.getElementById('max_number');
            const maxMinus = document.querySelector('.max-minus');
            const maxPlus = document.querySelector('.max-plus');
            if (maxMinus) maxMinus.addEventListener('click', ()=>{ if(maxInput && Number(maxInput.value) > 1) maxInput.value = Number(maxInput.value)-1; });
            if (maxPlus) maxPlus.addEventListener('click', ()=>{ if(maxInput) maxInput.value = Number(maxInput.value)+1; });
        });
    </script>
    <div style="margin-top:18px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
        <a href="{{ url_for('index') }}" class="nav-link">‚Üê Back to Games</a>
        <span></span>
        <span></span>
    </div>
    <div style="margin-top:12px; text-align:center; color: rgba(255,255,255,0.5); font-size: 12px;">
        ¬© Cigav Productions LLC
    </div>
</body>
</html>
