<!DOCTYPE html>
<!-- Â© Cigav Productions LLC -->
<html>
<head>
    <title>{{ game_info.name if game_info else 'Money Match' }}</title>
    <style>
        :root {
            --bg: #0b1220;
            --panel: #0e213d;
            --accent: #22c55e;
            --accent-2: #facc15;
            --text: #f8fafc;
            --muted: #cbd5e1;
            --error: #ef4444;
            --bill20-img: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='480' height='240' viewBox='0 0 480 240'><defs><linearGradient id='g20' x1='0%' y1='0%' x2='100%' y2='0%'><stop offset='0%' stop-color='%230b3a1c'/><stop offset='55%' stop-color='%2338ef7d'/><stop offset='100%' stop-color='%2315562f'/></linearGradient></defs><rect x='8' y='8' rx='18' ry='18' width='464' height='224' fill='url(%23g20)' stroke='%23d1f5d3' stroke-width='4'/><rect x='26' y='26' width='110' height='70' rx='12' ry='12' fill='none' stroke='%23d1f5d3' stroke-width='4'/><rect x='344' y='70' width='90' height='100' rx='12' ry='12' fill='none' stroke='%23d1f5d3' stroke-width='4'/><text x='80' y='70' font-family='Arial' font-size='34' font-weight='700' fill='%23d1f5d3'>$20</text><text x='240' y='135' font-family='Georgia' font-size='68' font-weight='700' fill='%23d1f5d3' text-anchor='middle'>20</text><text x='389' y='132' font-family='Arial' font-size='24' font-weight='700' fill='%23d1f5d3' text-anchor='middle'>USD</text></svg>");
            --bill5-img: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='480' height='240' viewBox='0 0 480 240'><defs><linearGradient id='g5' x1='0%' y1='0%' x2='100%' y2='0%'><stop offset='0%' stop-color='%230c1c42'/><stop offset='55%' stop-color='%23598dff'/><stop offset='100%' stop-color='%2310296b'/></linearGradient></defs><rect x='8' y='8' rx='18' ry='18' width='464' height='224' fill='url(%23g5)' stroke='%23d6e6ff' stroke-width='4'/><rect x='26' y='26' width='110' height='70' rx='12' ry='12' fill='none' stroke='%23d6e6ff' stroke-width='4'/><rect x='344' y='70' width='90' height='100' rx='12' ry='12' fill='none' stroke='%23d6e6ff' stroke-width='4'/><text x='80' y='70' font-family='Arial' font-size='34' font-weight='700' fill='%23d6e6ff'>$5</text><text x='240' y='135' font-family='Georgia' font-size='68' font-weight='700' fill='%23d6e6ff' text-anchor='middle'>5</text><text x='389' y='132' font-family='Arial' font-size='24' font-weight='700' fill='%23d6e6ff' text-anchor='middle'>USD</text></svg>");
            --bill1-img: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='480' height='240' viewBox='0 0 480 240'><defs><linearGradient id='g1' x1='0%' y1='0%' x2='100%' y2='0%'><stop offset='0%' stop-color='%2309281c'/><stop offset='55%' stop-color='%232fb56a'/><stop offset='100%' stop-color='%2310562e'/></linearGradient></defs><rect x='8' y='8' rx='18' ry='18' width='464' height='224' fill='url(%23g1)' stroke='%23d1f5d3' stroke-width='4'/><rect x='26' y='26' width='110' height='70' rx='12' ry='12' fill='none' stroke='%23d1f5d3' stroke-width='4'/><rect x='344' y='70' width='90' height='100' rx='12' ry='12' fill='none' stroke='%23d1f5d3' stroke-width='4'/><text x='80' y='70' font-family='Arial' font-size='34' font-weight='700' fill='%23d1f5d3'>$1</text><text x='240' y='135' font-family='Georgia' font-size='68' font-weight='700' fill='%23d1f5d3' text-anchor='middle'>1</text><text x='389' y='132' font-family='Arial' font-size='24' font-weight='700' fill='%23d1f5d3' text-anchor='middle'>USD</text></svg>");
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 14px;
            font-family: "Trebuchet MS", Arial, sans-serif;
            background: radial-gradient(circle at 15% 20%, #1f2f4f, #0b1220 60%);
            color: var(--text);
        }
        a { color: var(--text); text-decoration: none; }
        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            border-radius: 10px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.08);
            transition: all 0.2s;
        }
        .nav-link:hover { background: rgba(255,255,255,0.14); }
        .shell {
            max-width: 1100px;
            margin: 0 auto;
        }
        .panel {
            background: var(--panel);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 20px;
            padding: 18px;
            margin-top: 12px;
            box-shadow: 0 14px 30px rgba(0,0,0,0.35);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .title {
            font-size: 34px;
            margin: 0;
            letter-spacing: 0.4px;
        }
        .score-chip, .round-chip {
            padding: 10px 14px;
            border-radius: 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.08);
            font-weight: 700;
        }
        .grid {
            display: grid;
            grid-template-columns: minmax(360px, 1fr) minmax(360px, 1fr);
            gap: 16px;
            margin-top: 10px;
            align-items: start;
        }
        @media (max-width: 1100px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .bills {
                grid-template-columns: repeat(2, minmax(160px, 1fr)) !important;
            }
        }
        .item-card {
            position: relative;
            overflow: hidden;
        }
        .item-card img {
            width: 100%;
            max-height: 240px;
            object-fit: contain;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.12);
            background: #0f172a;
        }
        .item-meta {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }
        .pill {
            padding: 12px 14px;
            border-radius: 14px;
            background: rgba(255,255,255,0.09);
            border: 1px solid rgba(255,255,255,0.12);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 800;
        }
        .pill .label { color: var(--muted); font-weight: 600; }
        .total-due {
            background: linear-gradient(135deg, var(--accent), #16a34a);
            color: #0f172a;
            font-size: 22px;
            border: none;
        }
        .bills {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        .bill-card {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.16);
            border-radius: 16px;
            padding: 16px;
            transition: transform 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
        }
        .bill-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.2); box-shadow: 0 10px 18px rgba(0,0,0,0.28); }
        .stack-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stack {
            position: relative;
            min-height: 190px;
            border-radius: 16px;
            padding: 16px 12px 12px 12px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.12);
            background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.05), rgba(255,255,255,0.015) 60%), linear-gradient(135deg, #122843, #0e1e35);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.05), 0 12px 18px rgba(0,0,0,0.34);
        }
        .stack .stack-label {
            font-weight: 700;
            color: var(--muted);
            margin-top: 10px;
            font-size: 13px;
        }
        .bill-stack {
            position: relative;
            width: 108%;
            margin-left: -4%;
            height: 170px;
        }
        .bill-layer {
            position: absolute;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 110%;
            margin-left: -5%;
            height: auto;
            aspect-ratio: 61 / 26;
            border-radius: 6px;
            background-repeat: no-repeat;
            background-position: center center;
            background-size: cover;
            background-color: transparent;
            box-shadow: none;
            border: none;
            transform: translateY(0);
            transition: transform 0.25s ease, opacity 0.25s ease;
            overflow: hidden;
        }
        .bill-layer.d20 { background-image: url('/static/bills/20.jpg'); }
        .bill-layer.d10 { background-image: url('/static/bills/10.jpg'); }
        .bill-layer.d5 { background-image: url('/static/bills/5.jpg'); }
        .bill-layer.d1 { background-image: url('/static/bills/1.jpg'); }
        .stack.available .bill-layer { opacity: 1; }
        .stack.used .bill-layer { opacity: 1; }
        .stack.available:hover .bill-layer { opacity: 1; }
        .flying-bill.d20 { background-image: url('/static/bills/20.jpg'); background-repeat: no-repeat; background-position: center; background-size: cover; }
        .flying-bill.d10 { background-image: url('/static/bills/10.jpg'); background-repeat: no-repeat; background-position: center; background-size: cover; }
        .flying-bill.d5 { background-image: url('/static/bills/5.jpg'); background-repeat: no-repeat; background-position: center; background-size: cover; }
        .flying-bill.d1 { background-image: url('/static/bills/1.jpg'); background-repeat: no-repeat; background-position: center; background-size: cover; }
        .bill-value { font-size: 30px; font-weight: 900; margin-top: 10px; }
        .stack-count-chip {
            margin-top: 6px;
            display: inline-flex;
            gap: 6px;
            align-items: center;
            background: rgba(15,23,42,0.4);
            padding: 6px 10px;
            border-radius: 10px;
            font-weight: 800;
            color: var(--text);
            border: 1px solid rgba(255,255,255,0.14);
        }
        .flying-bill {
            position: fixed;
            width: 120px;
            height: 46px;
            border-radius: 12px;
            background-size: 180% 180%;
            box-shadow: 0 12px 20px rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.24);
            z-index: 9999;
            transition: transform 0.24s ease, opacity 0.24s ease;
        }
        .totals {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }
        .totals .pill { align-items: center; }
        .delta.ok { color: var(--accent); }
        .delta.bad { color: var(--error); }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 14px;
        }
        .btn {
            padding: 14px 18px;
            border: none;
            border-radius: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
            font-size: 16px;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: var(--accent); color: #0f172a; }
        .btn-ghost { background: rgba(255,255,255,0.08); color: var(--text); border: 1px solid rgba(255,255,255,0.12); }
        .btn-danger { background: var(--error); color: #0f172a; }
        .messages {
            margin-top: 14px;
            display: grid;
            gap: 8px;
        }
        .msg {
            padding: 10px 12px;
            border-radius: 10px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
        }
        .msg.correct { border-color: rgba(34,197,94,0.5); }
        .msg.incorrect { border-color: rgba(239,68,68,0.6); }
        .history {
            margin-top: 18px;
        }
        .history h3 { margin: 0 0 8px 0; }
        .history-list {
            display: grid;
            gap: 8px;
        }
        .history-item {
            padding: 12px;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            display: grid;
            grid-template-columns: 1.2fr 1fr 1fr;
            gap: 10px;
            align-items: center;
        }
        .history-item small { color: var(--muted); }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        .config-grid label { display: block; color: var(--muted); margin-bottom: 4px; font-weight: 700; }
        .config-grid input, .config-grid select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(20,30,50,0.9);
            color: #f8fafc;
            font-size: 15px;
            appearance: none;
        }
        .config-grid input[type="checkbox"] {
            width: 26px;
            height: 26px;
            padding: 0;
            margin: 0;
            appearance: auto;
            accent-color: #22c55e;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        .config-grid option { background: #0e213d; color: #f8fafc; }
        .endcard { text-align: center; }
        .money-layout {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .info-col {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            min-width: 280px;
        }
        .stacks-col {
            flex: 1;
        }
        .stacks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }
        @media (orientation: landscape) {
            .money-layout { flex-direction: row; align-items: flex-start; }
            .info-col { max-width: 520px; }
            .stacks-grid { grid-template-columns: repeat(2, minmax(220px, 1fr)); }
            .item-card img { max-height: 240px; }
            .bill-card { padding: 10px; }
            .stack-row { height: 140px; }
            .bill-stack[data-stack], .bill-stack[data-used] { height: 120px; }
            .actions { grid-template-columns: repeat(2, minmax(160px, 1fr)); }
            .panel { padding: 16px; }
        }
        @media (max-width: 900px) {
            .grid { grid-template-columns: 1fr; }
            .history-item { grid-template-columns: 1fr; }
            .item-card img { max-height: 200px; }
            .panel { padding: 14px; }
            body { padding: 10px; }
        }
    </style>
</head>
<body>
    {% set game_data = session.games[game_id] if session.games and session.games.get(game_id) else {} %}
    {% set show_tax_val = game_config.get('show_tax', default_config.get('show_tax', True)) %}
    {% set req_min_val = game_config.get('require_minimal_bills', default_config.get('require_minimal_bills', False)) %}
    {% set allow_overpay_val = game_config.get('allow_overpay', default_config.get('allow_overpay', False)) %}
    {% set limit_mode = game_config.get('bill_limit_mode', default_config.get('bill_limit_mode', 'easy')) %}
    <div class="shell" id="money-app" data-active="{{ 'true' if game_active else 'false' }}" data-over="{{ 'true' if game_over else 'false' }}">
        <div class="panel" id="config-panel" style="{% if game_active or game_over %}display:none;{% endif %}">
            <div class="header" style="margin-bottom:12px;">
                <div>
                    <p class="title">{{ game_info.name if game_info else 'Money Match' }}</p>
                    <div style="color: var(--muted)">Match the total using the smallest number of $20, $10, $5, and $1 bills.</div>
                </div>
            </div>
            <form id="config-form">
                <div class="config-grid" style="align-items:flex-start; gap:18px; font-size:18px;">
                    <div style="display:flex; flex-direction:column; gap:10px; padding:6px 0;">
                        <label style="display:flex; align-items:center; gap:12px; font-size:20px; font-weight:700; cursor:pointer;" for="show_tax">
                            <input type="checkbox" id="show_tax" name="show_tax" value="true" {% if show_tax_val %}checked{% endif %}>
                            <span>Display sales tax</span>
                        </label>
                        <div id="tax_rate_wrap" style="margin-top:8px; {% if not show_tax_val %}display:none;{% endif %}">
                            <label for="tax_rate" style="margin-bottom:4px; font-size:18px;">Sales tax rate</label>
                            <input type="number" step="0.00001" min="0" id="tax_rate" name="tax_rate" value="{{ game_config.get('tax_rate', default_config.get('tax_rate', 0.08)) }}" style="font-size:18px; padding:12px; border-radius:10px;">
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:10px; padding:6px 0;">
                        <label for="rounds" style="font-size:20px; font-weight:700;">Rounds</label>
                        <input type="number" id="rounds" name="rounds" min="1" value="{{ game_config.get('rounds', default_config.get('rounds', 8)) }}" required style="font-size:18px; padding:12px; border-radius:10px;">
                    </div>
                    <div style="display:flex; flex-direction:column; gap:10px; padding:6px 0;">
                        <label for="max_price" style="font-size:20px; font-weight:700;">Max item price</label>
                        <input type="number" id="max_price" name="max_price" min="1" value="{{ game_config.get('max_price', default_config.get('max_price', 50)) }}" required style="font-size:18px; padding:12px; border-radius:10px;">
                    </div>
                    <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center; padding:6px 0;">
                        <label style="display:flex; align-items:center; gap:10px; font-size:20px; font-weight:700; cursor:pointer;" for="require_minimal_bills">
                            <input type="checkbox" id="require_minimal_bills" name="require_minimal_bills" value="true" {% if req_min_val %}checked{% endif %}>
                            <span>Require fewest bills</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; font-size:20px; font-weight:700; cursor:pointer;" for="allow_overpay">
                            <input type="checkbox" id="allow_overpay" name="allow_overpay" value="true" {% if allow_overpay_val %}checked{% endif %}>
                            <span>Allow overpay</span>
                        </label>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:10px; padding:6px 0;">
                        <label for="bill_limit_mode" style="font-size:20px; font-weight:700;">Bill availability</label>
                        <select id="bill_limit_mode" name="bill_limit_mode" style="font-size:18px; padding:12px; border-radius:10px;">
                            <option value="easy" {% if limit_mode == 'easy' %}selected{% endif %}>Easy (unlimited)</option>
                            <option value="intermediate" {% if limit_mode == 'intermediate' %}selected{% endif %}>Intermediate (fixed limits)</option>
                            <option value="hard" {% if limit_mode == 'hard' %}selected{% endif %}>Hard (random limits)</option>
                        </select>
                    </div>
                </div>
                <div class="actions" style="margin-top:18px;">
                    <button type="button" id="start-game-btn" class="btn btn-primary" style="font-size:20px; padding:14px 22px;">Start game</button>
                </div>
            </form>
        </div>

        <div class="panel" id="play-panel" style="{% if not game_active %}display:none;{% endif %}">
            <div class="header">
                <div>
                    <p class="title">{{ game_info.name if game_info else 'Money Match' }}</p>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <div class="round-chip" id="round-chip">Round {{ game_data.get('current_round', 0) + 1 }} / {{ game_data.get('config', {}).get('rounds', default_config.get('rounds', 8)) }}</div>
                    <div class="score-chip" id="score-chip">Score {{ game_data.get('score', 0) }}</div>
                </div>
            </div>
            <div class="money-layout" id="play-layout">
                <div class="info-col">
                    <div style="display:grid; grid-template-columns: minmax(220px, 1fr) minmax(180px, 0.8fr); gap:14px; align-items:start;">
                        <div class="item-card">
                            <img id="item-image" src="{{ game_data.get('item_image') }}" alt="Item image" style="max-height:280px; object-fit:contain; width:100%;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <div>
                                <div id="item-price" style="font-size: 40px; font-weight: 900;">${{ game_data.get('item_price', 0) }}</div>
                                {% if game_data.get('show_tax', True) %}
                                    {% set tax_rate_val = game_data.get('tax_rate', default_config.get('tax_rate', 0.08)) %}
                                    {% set tax_amount_val = game_data.get('tax_amount', 0) %}
                                    {% set tax_display = ('%.2f' % tax_amount_val) %}
                                    {% set rate_display = ('%.2f' % (tax_rate_val * 100)) %}
                                    <div id="tax-info" style="font-size: 16px; color: var(--muted); margin-top:4px;">Tax {{ rate_display }}%: ${{ tax_display }}</div>
                                {% else %}
                                    <div id="tax-info" style="font-size: 16px; color: var(--muted); margin-top:4px; display:none;"></div>
                                {% endif %}
                                <div id="require-hint" style="font-size: 14px; color: var(--muted); margin-top:4px; {% if not req_min_val %}display:none;{% endif %}">
                                    Use the fewest bills possible to match the total.
                                </div>
                            </div>
                            <div class="pill total-due" style="background: linear-gradient(135deg, #eab308, #f59e0b); color: #0f172a; border: none; font-size: 24px; padding:16px 20px; box-shadow: 0 10px 18px rgba(0,0,0,0.28); justify-content:space-between; min-width: 220px;">
                                <span class="label" style="color:#0f172a;">Total Due</span>
                                <span id="total-due" style="font-weight:900; font-size:36px;">${{ '%.2f' % game_data.get('total_due', 0) }}</span>
                            </div>
                            <div class="totals" style="width:100%; display:flex; flex-direction:column; gap:10px;">
                                <div class="pill">
                                    <span class="label">You selected</span>
                                    <span id="selected-total">$0</span>
                                </div>
                                <div class="pill">
                                    <span class="label">Difference</span>
                                    <span id="delta" class="delta bad">$0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="actions" style="margin-top:12px; display:grid; gap:10px; grid-template-columns: repeat(2, minmax(160px, 1fr)); width:100%;">
                        <button id="submit-btn" class="btn btn-primary" aria-label="Submit payment" style="font-size:18px;">Submit payment</button>
                        <button type="button" id="clear-btn" class="btn btn-ghost" aria-label="Clear bills" style="font-size:16px;">Clear bills</button>
                        <button type="button" id="skip-btn" class="btn btn-ghost" style="font-size:16px;">Skip item</button>
                        <button type="button" id="restart-btn" class="btn btn-danger" style="font-size:16px;">Restart</button>
                    </div>
                    <div class="messages" id="messages-box" style="margin-top:12px;">
                        {% for m in messages %}
                            <div class="msg {% if 'Correct' in m %}correct{% elif 'Incorrect' in m %}incorrect{% endif %}">{{ m }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="stacks-col">
                    <form id="money-form">
                        <input type="hidden" name="answer" id="answer-field" value="20:0,10:0,5:0,1:0">
                        <input type="hidden" id="debug_payload" name="debug_payload" value="">
                        <input type="hidden" id="count-20" name="count_20" value="0">
                        <input type="hidden" id="count-10" name="count_10" value="0">
                        <input type="hidden" id="count-5" name="count_5" value="0">
                        <input type="hidden" id="count-1" name="count_1" value="0">
                        <div class="bills stacks-grid">
                            {% for denom, img in {20:'/static/bills/20.jpg',10:'/static/bills/10.jpg',5:'/static/bills/5.jpg',1:'/static/bills/1.jpg'}.items() %}
                            <div class="bill-card" data-denom="{{ denom }}">
                                <div class="stack-row">
                                    <div class="stack available" data-denom="{{ denom }}" data-action="add">
                                        <div class="bill-stack" data-stack="{{ denom }}"></div>
                                        <div class="stack-label">Tap stack to add</div>
                                    </div>
                                    <div class="stack used" data-denom="{{ denom }}" data-action="remove">
                                        <div class="bill-stack" data-used="{{ denom }}"></div>
                                        <div class="stack-label">In use</div>
                                    </div>
                                </div>
                                <div class="bill-value">${{ denom }} bills</div>
                                <div class="stack-count-chip">
                                    ${{ denom }} in use: <span data-count="{{ denom }}">0</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </form>
                </div>
            </div>
            <div class="history" style="margin-top:18px;">
                <h3>Recent attempts</h3>
                <div class="history-list" id="history-list">
                    {% if session.history %}
                        {% for entry in session.history[-6:]|reverse %}
                        <div class="history-item">
                            <div>
                                <strong>{{ entry.item_name }}</strong>
                                <div><small>Price ${{ entry.item_price }}{% if entry.show_tax %} + tax ${{ entry.tax_amount }}{% endif %}</small></div>
                            </div>
                            <div>
                                <div><small>Your bills</small></div>
                                <div>{{ entry.user_counts.get(20,0) }}x$20, {{ entry.user_counts.get(10,0) }}x$10, {{ entry.user_counts.get(5,0) }}x$5, {{ entry.user_counts.get(1,0) }}x$1</div>
                                <div><small>Total ${{ entry.user_total or 0 }}</small></div>
                            </div>
                            <div>
                                {% if entry.skipped %}
                                    <span style="color: var(--muted); font-weight:700;">Skipped</span>
                                {% elif entry.is_correct %}
                                    <span style="color: var(--accent); font-weight:700;">Correct</span>
                                {% else %}
                                    <span style="color: var(--error); font-weight:700;">Try again</span>
                                {% endif %}
                                <div><small>Best: {{ entry.best_counts.get(20,0) }}x$20, {{ entry.best_counts.get(10,0) }}x$10, {{ entry.best_counts.get(5,0) }}x$5, {{ entry.best_counts.get(1,0) }}x$1</small></div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="panel" id="over-panel" style="{% if not game_over %}display:none;{% endif %}">
            <div class="endcard">
                <p class="title" style="margin-bottom:6px;">{{ game_info.name if game_info else 'Money Match' }}</p>
                <div id="final-score" style="font-size:22px; margin-bottom:10px;">
                    {% if game_active or game_over %}
                        Final Score: {{ game_data.get('score',0) }} / {{ game_data.get('current_round',0) }}
                    {% endif %}
                </div>
                <button type="button" id="over-reset-btn" class="btn btn-primary" style="padding: 14px 20px;">Play again</button>
            </div>
            <div class="history" style="margin-top:18px;">
                <h3>All attempts</h3>
                <div class="history-list" id="history-all">
                    {% if session.history %}
                        {% for entry in session.history %}
                        <div class="history-item">
                            <div>
                                <strong>{{ entry.item_name }}</strong>
                                <div><small>Price ${{ entry.item_price }}{% if entry.show_tax %} + tax ${{ entry.tax_amount }}{% endif %}</small></div>
                            </div>
                            <div>
                                <div><small>Your bills</small></div>
                                <div>{{ entry.user_counts.get(20,0) }}x$20, {{ entry.user_counts.get(10,0) }}x$10, {{ entry.user_counts.get(5,0) }}x$5, {{ entry.user_counts.get(1,0) }}x$1</div>
                                <div><small>Total ${{ entry.user_total or 0 }}</small></div>
                            </div>
                            <div>
                                {% if entry.skipped %}
                                    <span style="color: var(--muted); font-weight:700;">Skipped</span>
                                {% elif entry.is_correct %}
                                    <span style="color: var(--accent); font-weight:700;">Correct</span>
                                {% else %}
                                    <span style="color: var(--error); font-weight:700;">Try again</span>
                                {% endif %}
                                <div><small>Best: {{ entry.best_counts.get(20,0) }}x$20, {{ entry.best_counts.get(10,0) }}x$10, {{ entry.best_counts.get(5,0) }}x$5, {{ entry.best_counts.get(1,0) }}x$1</small></div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function(){
            const app = document.getElementById('money-app');
            const configPanel = document.getElementById('config-panel');
            const playPanel = document.getElementById('play-panel');
            const overPanel = document.getElementById('over-panel');
            const playShell = document.getElementById('play-shell');
            const playWrapper = document.getElementById('play-wrapper');
            const configForm = document.getElementById('config-form');
            const startBtn = document.getElementById('start-game-btn');
            const submitBtn = document.getElementById('submit-btn');
            const skipBtn = document.getElementById('skip-btn');
            const restartBtn = document.getElementById('restart-btn');
            const overResetBtn = document.getElementById('over-reset-btn');
            const footerRestart = document.getElementById('footer-restart');
            const fsBtn = document.getElementById('fullscreen-btn');
            const roundChip = document.getElementById('round-chip');
            const scoreChip = document.getElementById('score-chip');
            const itemPriceEl = document.getElementById('item-price');
            const taxInfo = document.getElementById('tax-info');
            const requireHint = document.getElementById('require-hint');
            const totalDueEl = document.getElementById('total-due');
            const selectedTotal = document.getElementById('selected-total');
            const deltaEl = document.getElementById('delta');
            const messagesBox = document.getElementById('messages-box');
            const historyRecent = document.getElementById('history-list');
            const historyAll = document.getElementById('history-all');
            const finalScore = document.getElementById('final-score');
            const itemImg = document.getElementById('item-image');
            const answerField = document.getElementById('answer-field');
            const debugInput = document.getElementById('debug_payload');
            const showTaxSel = document.getElementById('show_tax');
            const taxWrap = document.getElementById('tax_rate_wrap');

            const counts = {20:0, 10:0, 5:0, 1:0};
            const pendingToUsed = {20:0, 10:0, 5:0, 1:0};
            const pendingToAvail = {20:0, 10:0, 5:0, 1:0};
            let maxCounts = {{ game_data.get('available_counts', {'20':999,'10':999,'5':999,'1':999})|tojson }};
            let totalDue = parseFloat('{{ "%.2f"|format(game_data.get("total_due", 0) if game_active else 0) }}') || 0;
            const debugCounts = {{ 'true' if request.args.get('debug_counts') else 'false' }};
            let debugBox = null;
            if (debugCounts) {
                debugBox = document.createElement('div');
                debugBox.id = 'debug-counts';
                debugBox.style.position = 'fixed';
                debugBox.style.bottom = '10px';
                debugBox.style.right = '10px';
                debugBox.style.background = 'rgba(0,0,0,0.7)';
                debugBox.style.color = '#fff';
                debugBox.style.padding = '8px';
                debugBox.style.fontSize = '12px';
                debugBox.style.maxWidth = '360px';
                debugBox.style.zIndex = '9999';
                debugBox.style.borderRadius = '8px';
                document.body.appendChild(debugBox);
            }

            function normalizeCounts(obj) {
                const mapped = {};
                Object.keys(obj || {}).forEach(key => {
                    const denom = parseInt(key, 10);
                    mapped[denom] = obj[key];
                });
                return mapped;
            }

            function resetCounts() {
                counts[20] = counts[10] = counts[5] = counts[1] = 0;
                pendingToAvail[20] = pendingToAvail[10] = pendingToAvail[5] = pendingToAvail[1] = 0;
                pendingToUsed[20] = pendingToUsed[10] = pendingToUsed[5] = pendingToUsed[1] = 0;
            }

            function syncAnswer() {
                if (answerField) {
                    answerField.value = `20:${counts[20]},10:${counts[10]},5:${counts[5]},1:${counts[1]}`;
                }
                ['20','10','5','1'].forEach(denom => {
                    const input = document.getElementById(`count-${denom}`);
                    if (input) input.value = counts[parseInt(denom,10)];
                });
            }

            function updateDebug(effCounts) {
                if (!debugCounts || !debugBox) return;
                const eff = effCounts || counts;
                if (debugInput) {
                    debugInput.value = JSON.stringify({
                        counts,
                        pendingToUsed,
                        pendingToAvail,
                        maxCounts,
                        effective: eff,
                        answer: answerField ? answerField.value : ''
                    });
                }
                debugBox.innerText =
                    `counts=${JSON.stringify(counts)} | ` +
                    `pendingToUsed=${JSON.stringify(pendingToUsed)} | ` +
                    `pendingToAvail=${JSON.stringify(pendingToAvail)} | ` +
                    `max=${JSON.stringify(maxCounts)} | ` +
                    `effective=${JSON.stringify(eff)} | ` +
                    `answer=${answerField ? answerField.value : ''}`;
            }

            function updateTotals() {
                const total = counts[20]*20 + counts[10]*10 + counts[5]*5 + counts[1];
                if (selectedTotal) selectedTotal.textContent = `$${total}`;
                if (deltaEl) {
                    const delta = total - Math.ceil(totalDue);
                    const displayDelta = Math.round((total - totalDue) * 100) / 100;
                    deltaEl.textContent = `${displayDelta >= 0 ? '+' : ''}$${displayDelta.toFixed(2)}`;
                    deltaEl.className = Math.abs(delta) < 0.01 ? 'delta ok' : 'delta bad';
                }
                document.querySelectorAll('[data-count]').forEach(el => {
                    const denom = Number(el.getAttribute('data-count'));
                    el.textContent = counts[denom];
                });
                syncAnswer();
                updateDebug();
            }

            function renderStacks() {
                [20,10,5,1].forEach(denom => {
                    const available = document.querySelector(`[data-stack="${denom}"]`);
                    const used = document.querySelector(`[data-used="${denom}"]`);
                    const max = Number(maxCounts[String(denom)] ?? maxCounts[denom] ?? 999);
                    const remaining = Math.max(0, max - counts[denom] - pendingToUsed[denom] + pendingToAvail[denom]);
                    const usedCount = Math.max(0, counts[denom]);
                    if (available) buildStack(available, remaining, denom);
                    if (used) buildStack(used, usedCount, denom);
                });
            }

            function buildStack(container, count, denom) {
                container.innerHTML = '';
                const layers = Math.max(0, count);
                for (let i = 0; i < layers; i++) {
                    const layer = document.createElement('div');
                    layer.className = 'bill-layer';
                    layer.classList.add(denom === 20 ? 'd20' : denom === 10 ? 'd10' : denom === 5 ? 'd5' : 'd1');
                    const offset = (layers - i - 1) * 14;
                    layer.style.transform = `translateY(${offset}px)`;
                    layer.style.opacity = 1;
                    container.appendChild(layer);
                }
            }

            function flyBill(denom, fromEl, toEl, onEnd) {
                if (!fromEl || !toEl) { onEnd && onEnd(); return; }
                const rectFrom = fromEl.getBoundingClientRect();
                const rectTo = toEl.getBoundingClientRect();
                const bill = document.createElement('div');
                bill.className = 'flying-bill';
                bill.classList.add(denom === 20 ? 'd20' : denom === 10 ? 'd10' : denom === 5 ? 'd5' : 'd1');
                const startX = rectFrom.left + rectFrom.width/2 - 60;
                const startY = rectFrom.top + rectFrom.height/2 - 23;
                bill.style.left = `${startX}px`;
                bill.style.top = `${startY}px`;
                document.body.appendChild(bill);
                let timer = null;
                const cleanup = () => {
                    if (timer) clearTimeout(timer);
                    bill.remove();
                    onEnd && onEnd();
                };
                requestAnimationFrame(() => {
                    const dx = (rectTo.left + rectTo.width/2) - (rectFrom.left + rectFrom.width/2);
                    const dy = (rectTo.top + rectTo.height/2) - (rectFrom.top + rectFrom.height/2);
                    bill.style.transform = `translate(${dx}px, ${dy}px) scale(0.98)`;
                    bill.style.opacity = '0.9';
                });
                bill.addEventListener('transitionend', cleanup, { once: true });
                timer = setTimeout(cleanup, 340);
            }

            function handleStackTap(e) {
                e.preventDefault();
                e.stopPropagation();
                const stack = e.currentTarget;
                const denom = Number(stack.getAttribute('data-denom'));
                const action = stack.getAttribute('data-action');
                const max = Number(maxCounts[String(denom)] ?? maxCounts[denom] ?? 999);
                if (action === 'add') {
                    if (counts[denom] + pendingToUsed[denom] >= max) return;
                    const used = document.querySelector(`.stack.used[data-denom="${denom}"]`);
                    pendingToUsed[denom] += 1;
                    renderStacks();
                    updateTotals();
                    updateDebug();
                    flyBill(denom, stack, used, () => {
                        pendingToUsed[denom] = Math.max(0, pendingToUsed[denom]-1);
                        counts[denom] = Math.min(max, counts[denom] + 1);
                        updateTotals();
                        renderStacks();
                        syncAnswer();
                        updateDebug();
                    });
                } else if (action === 'remove') {
                    if (counts[denom] <= 0) return;
                    const avail = document.querySelector(`.stack.available[data-denom="${denom}"]`);
                    counts[denom] = Math.max(0, counts[denom] - 1);
                    pendingToAvail[denom] += 1;
                    updateTotals();
                    renderStacks();
                    syncAnswer();
                    updateDebug();
                    flyBill(denom, stack, avail, () => {
                        pendingToAvail[denom] = Math.max(0, pendingToAvail[denom]-1);
                        updateTotals();
                        renderStacks();
                        syncAnswer();
                        updateDebug();
                    });
                }
            }

            document.querySelectorAll('.stack').forEach(stack => {
                stack.style.touchAction = 'manipulation';
                stack.addEventListener('click', handleStackTap);
            });

            function renderHistory(list, target) {
                if (!target) return;
                target.innerHTML = '';
                (list || []).forEach(entry => {
                    const user = entry.user_counts || {};
                    const best = entry.best_counts || {};
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <div>
                            <strong>${entry.item_name || ''}</strong>
                            <div><small>Price $${entry.item_price || 0}${entry.show_tax ? ' + tax $' + (entry.tax_amount || 0) : ''}</small></div>
                        </div>
                        <div>
                            <div><small>Your bills</small></div>
                            <div>${user[20] || 0}x$20, ${user[10] || 0}x$10, ${user[5] || 0}x$5, ${user[1] || 0}x$1</div>
                            <div><small>Total $${entry.user_total || 0}</small></div>
                        </div>
                        <div>
                            ${entry.skipped ? '<span style="color: var(--muted); font-weight:700;">Skipped</span>' :
                                entry.is_correct ? '<span style="color: var(--accent); font-weight:700;">Correct</span>' :
                                '<span style="color: var(--error); font-weight:700;">Try again</span>'}
                            <div><small>Best: ${best[20] || 0}x$20, ${best[10] || 0}x$10, ${best[5] || 0}x$5, ${best[1] || 0}x$1</small></div>
                        </div>`;
                    target.appendChild(div);
                });
            }

            async function submitAjax(action, payload = {}) {
                const body = Object.assign({ action }, payload);
                const res = await fetch(location.pathname, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(body)
                });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`Network error ${res.status}: ${text}`);
                }
                return res.json();
            }

            function applyState(data) {
                if (!data) return;
                if (app) {
                    app.dataset.active = data.game_active ? 'true' : 'false';
                    app.dataset.over = data.game_over ? 'true' : 'false';
                }
                const totalRounds = data.total_rounds || (data.config && data.config.rounds) || 0;
                if (roundChip) {
                    const roundDisplay = data.game_over ? totalRounds : Math.min(data.current_round + 1, totalRounds);
                    roundChip.textContent = `Round ${roundDisplay} / ${totalRounds}`;
                }
                if (scoreChip) scoreChip.textContent = `Score ${data.score}`;
                const item = data.item || {};
                if (itemPriceEl) itemPriceEl.textContent = `$${item.price ?? 0}`;
                if (taxInfo) {
                    if (item.show_tax) {
                        taxInfo.style.display = 'block';
                        const rate = item.tax_rate !== undefined ? item.tax_rate : 0;
                        taxInfo.textContent = `Tax ${(rate * 100).toFixed(2)}%: $${Number(item.tax_amount || 0).toFixed(2)}`;
                    } else {
                        taxInfo.style.display = 'none';
                    }
                }
                if (requireHint) {
                    requireHint.style.display = (data.config && data.config.require_minimal_bills) ? 'block' : 'none';
                }
                if (totalDueEl) totalDueEl.textContent = `$${Number(item.total_due || 0).toFixed(2)}`;
                if (itemImg && item.image) itemImg.src = item.image;
                totalDue = Number(item.total_due || 0);
                maxCounts = normalizeCounts(data.available_counts || {});
                resetCounts();
                renderStacks();
                updateTotals();
                if (messagesBox) {
                    messagesBox.innerHTML = '';
                    (data.messages || []).forEach(m => {
                        const div = document.createElement('div');
                        div.className = 'msg';
                        if (m.includes('Correct')) div.classList.add('correct');
                        else if (m.includes('Incorrect')) div.classList.add('incorrect');
                        div.textContent = m;
                        messagesBox.appendChild(div);
                    });
                }
                renderHistory(data.history || [], historyRecent);
                renderHistory(data.full_history || [], historyAll);
                if (finalScore) {
                    finalScore.textContent = `Final Score: ${data.score} / ${totalRounds}`;
                }
                if (data.config) {
                    const cfg = data.config;
                    const setVal = (id, val) => {
                        const el = document.getElementById(id);
                        if (el) el.value = val;
                    };
                    setVal('rounds', cfg.rounds);
                    setVal('max_price', cfg.max_price);
                    const setBool = (id, val) => {
                        const el = document.getElementById(id);
                        if (el) el.checked = !!val;
                    };
                    setBool('show_tax', cfg.show_tax);
                    setBool('require_minimal_bills', cfg.require_minimal_bills);
                    setBool('allow_overpay', cfg.allow_overpay);
                    const taxRateInput = document.getElementById('tax_rate');
                    if (taxRateInput && cfg.tax_rate !== undefined) taxRateInput.value = cfg.tax_rate;
                    const billMode = document.getElementById('bill_limit_mode');
                    if (billMode && cfg.bill_limit_mode) billMode.value = cfg.bill_limit_mode;
                    if (taxWrap && showTaxSel) {
                        taxWrap.style.display = showTaxSel.checked ? 'block' : 'none';
                    }
                }
                if (configPanel) configPanel.style.display = (data.game_active || data.game_over) ? 'none' : 'block';
                if (playPanel) playPanel.style.display = data.game_active ? 'block' : 'none';
                if (overPanel) overPanel.style.display = data.game_over ? 'block' : 'none';
                applyOrientationLayout();
                updateDebug();
            }

            function effectiveAnswer() {
                const eff = {20:0,10:0,5:0,1:0};
                [20,10,5,1].forEach(denom => {
                    const base = counts[denom] || 0;
                    const net = (pendingToUsed[denom] || 0) - (pendingToAvail[denom] || 0);
                    const max = Number(maxCounts[String(denom)] ?? maxCounts[denom] ?? 999);
                    eff[denom] = Math.max(0, Math.min(max, base + net));
                });
                if (answerField) answerField.value = `20:${eff[20]},10:${eff[10]},5:${eff[5]},1:${eff[1]}`;
                updateDebug(eff);
                return eff;
            }

            const clearBtn = document.getElementById('clear-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    resetCounts();
                    renderStacks();
                    updateTotals();
                });
            }

            if (showTaxSel && taxWrap) {
                const syncTax = () => taxWrap.style.display = showTaxSel.checked ? 'block' : 'none';
                showTaxSel.addEventListener('change', syncTax);
                syncTax();
            }

            if (startBtn) {
                startBtn.addEventListener('click', async () => {
                    startBtn.disabled = true;
                    try {
                        const payload = {
                            rounds: document.getElementById('rounds')?.value,
                            max_price: document.getElementById('max_price')?.value,
                            tax_rate: document.getElementById('tax_rate')?.value,
                            show_tax: document.getElementById('show_tax')?.checked,
                            require_minimal_bills: document.getElementById('require_minimal_bills')?.checked,
                            bill_limit_mode: document.getElementById('bill_limit_mode')?.value,
                            allow_overpay: document.getElementById('allow_overpay')?.checked,
                        };
                        const data = await submitAjax('start_game', payload);
                        applyState(data);
                    } catch (err) {
                        console.error(err);
                        alert('Could not start game. Please try again.');
                    } finally {
                        startBtn.disabled = false;
                    }
                });
            }

            if (submitBtn) {
                submitBtn.addEventListener('click', async () => {
                    if (!app || app.dataset.active !== 'true') return;
                    const eff = effectiveAnswer();
                    try {
                        const data = await submitAjax('answer', {
                            answer: answerField ? answerField.value : '',
                            debug_payload: debugInput ? debugInput.value : '',
                            counts: eff
                        });
                        applyState(data);
                    } catch (err) {
                        console.error(err);
                        alert('Could not submit. Please try again.');
                    }
                });
            }

            if (skipBtn) {
                skipBtn.addEventListener('click', async () => {
                    try {
                        const data = await submitAjax('skip_round');
                        applyState(data);
                    } catch (err) {
                        console.error(err);
                        alert('Could not skip. Please try again.');
                    }
                });
            }

            if (restartBtn) {
                restartBtn.addEventListener('click', async () => {
                    try {
                        const data = await submitAjax('reset_to_config');
                        applyState(data);
                    } catch (err) {
                        console.error(err);
                        alert('Could not restart. Please try again.');
                    }
                });
            }

            if (overResetBtn) {
                overResetBtn.addEventListener('click', async () => {
                    try {
                        const data = await submitAjax('reset_to_config');
                        applyState(data);
                    } catch (err) {
                        console.error(err);
                        alert('Could not reset. Please try again.');
                    }
                });
            }

            if (footerRestart) {
                footerRestart.addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        const data = await submitAjax('reset_to_config');
                        applyState(data);
                    } catch (err) {
                        console.error(err);
                        alert('Could not restart. Please try again.');
                    }
                });
            }

            if (fsBtn) {
                const updateFsButton = () => {
                    const isFs = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
                    fsBtn.textContent = isFs ? 'Exit full screen' : 'Full screen';
                };
                fsBtn.addEventListener('click', () => {
                    const el = document.documentElement;
                    const isFs = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
                    try {
                        if (isFs) {
                            const exit = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
                            if (exit) exit.call(document);
                        } else {
                            const request = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen;
                            if (request) request.call(el);
                            else alert('For full screen on iPhone/iPad, use âAdd to Home Screenâ from Safari.');
                        }
                    } catch (err) {
                        console.error(err);
                    }
                });
                document.addEventListener('fullscreenchange', updateFsButton);
                document.addEventListener('webkitfullscreenchange', updateFsButton);
                updateFsButton();
            }

            function applyOrientationLayout() {
                if (!playWrapper) return;
                const portrait = window.innerHeight > window.innerWidth;
                playWrapper.classList.toggle('portrait', portrait);
                if (playShell) playShell.classList.toggle('portrait', portrait);
            }

            window.addEventListener('resize', applyOrientationLayout);

            renderStacks();
            updateTotals();
            applyOrientationLayout();
        });
    </script>
    <div style="margin-top:18px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
        <a class="nav-link" href="{{ url_for('index') }}">&#x2190; Back to Games</a>
        <button id="fullscreen-btn" class="btn btn-ghost" style="padding:10px 18px; font-size:16px;">Full screen</button>
        <button id="footer-restart" class="btn btn-ghost" style="padding:10px 20px; font-size:16px;">Restart</button>
    </div>
    <div style="margin-top:12px; text-align:center; color: rgba(255,255,255,0.5); font-size: 12px;">
        Â© Cigav Productions LLC
    </div>
</body>
</html>
